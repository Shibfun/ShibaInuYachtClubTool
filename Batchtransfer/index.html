<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiba Inu Yacht Club - My NFTs</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: 'Montserrat', Arial, sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d); 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh; 
            color: #fff; 
        }
        .header { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        h1 { 
            font-size: 48px; 
            color: #ff8c00; 
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5); 
        }
        .wallet-info { 
            margin: 10px 0; 
            font-size: 16px; 
        }
        .action-btn { 
            padding: 10px 20px; 
            font-size: 16px; 
            background: linear-gradient(45deg, #ff8c00, #e07b00); 
            color: #1a1a1a; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .action-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.7); 
        }
        .action-btn:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        .action-btn.loading { 
            opacity: 0.7; 
            pointer-events: none; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: #2d2d2d; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            color: #fff; 
            max-width: 350px; 
            border: 2px solid #ff8c00; 
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.5); 
        }
        .modal-content p { 
            margin-bottom: 15px; 
            font-size: 18px; 
        }
        .modal-content button { 
            padding: 10px 20px; 
            background: #ff8c00; 
            color: #1a1a1a; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
        }
        .nft-viewer { 
            margin-top: 30px; 
            width: 100%; 
            max-width: 800px; 
        }
        .nft-viewer h2 { 
            font-size: 32px; 
            color: #ff8c00; 
            text-align: center; 
        }
        #nftList { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
            justify-content: center; 
        }
        .nft-card { 
            text-align: center; 
            background: #333; 
            padding: 10px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(255, 140, 0, 0.2); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .nft-card img { 
            width: 100%; 
            max-width: 150px; 
            height: auto; 
            border-radius: 5px; 
        }
        .nft-card p { 
            font-size: 14px; 
            margin: 5px 0; 
        }
        .nft-card input { 
            width: 100%; 
            padding: 5px; 
            margin-bottom: 5px; 
            border-radius: 5px; 
            border: 1px solid #ff8c00; 
            background: #1a1a1a; 
            color: #fff; 
            font-size: 12px; 
        }
        .nft-card .action-btn { 
            padding: 6px 12px; 
            font-size: 12px; 
            width: 100%; 
        }
        .batch-transfer { 
            margin: 20px 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px; 
            width: 100%; 
            max-width: 400px; 
        }
        .batch-transfer label { 
            font-size: 14px; 
            color: #ff8c00; 
            font-weight: bold; 
        }
        .batch-transfer textarea { 
            width: 100%; 
            height: 150px; 
            padding: 8px; 
            border-radius: 5px; 
            border: 1px solid #ff8c00; 
            background: #1a1a1a; 
            color: #fff; 
            font-size: 14px; 
            resize: vertical; 
        }
        @media (max-width: 768px) {
            h1 { font-size: 32px; }
            .wallet-info { font-size: 14px; }
            .action-btn { padding: 8px 16px; font-size: 14px; }
            .modal-content { max-width: 90%; padding: 15px; }
            .nft-viewer h2 { font-size: 24px; }
            #nftList { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .nft-card { padding: 8px; }
            .nft-card img { max-width: 120px; }
            .nft-card p { font-size: 12px; }
            .nft-card input { padding: 4px; font-size: 10px; }
            .nft-card .action-btn { padding: 5px 10px; font-size: 10px; }
            .batch-transfer textarea { padding: 6px; font-size: 12px; }
            .batch-transfer label { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Shiba Inu Yacht Club</h1>
        <div class="wallet-info">
            Wallet: <span id="walletAddress">Not connected</span>
        </div>
        <button id="connectWalletBtn" class="action-btn">Connect Wallet</button>
    </div>
    <div class="batch-transfer">
        <label for="batchInput">Batch Transfer (Format: address,amount per line, max total 100):</label>
        <textarea id="batchInput" placeholder="e.g.\n0x123...abc,1\n0x456...def,2"></textarea>
        <button id="batchTransferBtn" class="action-btn" onclick="batchTransferNFTs()" disabled>Batch Transfer</button>
    </div>
    <div class="nft-viewer">
        <h2>Your Shiba Inu Yacht Club NFTs</h2>
        <div id="nftList"></div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, siycContract, multiCallContract;
        const SIYC_CONTRACT_ADDRESS = "0xB33012feB12D590f4ee9B0D9999e95C30303A209";
        const MULTICALL_CONTRACT_ADDRESS = "0xC0e5f06aD47986B0F0755F85eE5D949241F8E76A";
        
        const SIYC_CONTRACT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "approved",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "ApprovalForAll",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "addressMintedBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "cost",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "getApproved",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "isApprovedForAll",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "maxSupply",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "uri",
                        "type": "string"
                    },
                    {
                        "internalType": "string[]",
                        "name": "attributes",
                        "type": "string[]"
                    }
                ],
                "name": "mintNFT",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "mintedCount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "uri",
                        "type": "string"
                    },
                    {
                        "internalType": "bytes32",
                        "name": "attributes",
                        "type": "bytes32"
                    }
                ],
                "name": "ownerMintWithData",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ownerOf",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bytes",
                        "name": "_data",
                        "type": "bytes"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "_approved",
                        "type": "bool"
                    }
                ],
                "name": "setApprovalForAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_newCost",
                        "type": "uint256"
                    }
                ],
                "name": "setCost",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes4",
                        "name": "interfaceId",
                        "type": "bytes4"
                    }
                ],
                "name": "supportsInterface",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "index",
                        "type": "uint256"
                    }
                ],
                "name": "tokenByIndex",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "index",
                        "type": "uint256"
                    }
                ],
                "name": "tokenOfOwnerByIndex",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "tokenURI",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "newTokenURI",
                        "type": "string"
                    }
                ],
                "name": "updateTokenMetadata",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes32",
                        "name": "",
                        "type": "bytes32"
                    }
                ],
                "name": "usedAttributeCombinations",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_owner",
                        "type": "address"
                    }
                ],
                "name": "walletOfOwner",
                "outputs": [
                    {
                        "internalType": "uint256[]",
                        "name": "",
                        "type": "uint256[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ];

        const MULTICALL_CONTRACT_ABI = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address[]",
                        "name": "to",
                        "type": "address[]"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256[]",
                        "name": "tokenIds",
                        "type": "uint256[]"
                    }
                ],
                "name": "BatchTransfer",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "internalType": "address[]",
                        "name": "to",
                        "type": "address[]"
                    },
                    {
                        "internalType": "uint256[]",
                        "name": "tokenIds",
                        "type": "uint256[]"
                    }
                ],
                "name": "batchTransfer",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        const shibariumMainnet = {
            chainId: '0x6d',
            chainName: 'Shibarium',
            nativeCurrency: {
                name: 'BONE',
                symbol: 'BONE',
                decimals: 18
            },
            rpcUrls: ['https://www.shibrpc.com'],
            blockExplorerUrls: ['https://shibariumscan.io']
        };

        // Show modal with message
        function showModal(message) {
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Connect to wallet and ensure Shibarium network
        async function connectWallet() {
            const connectButton = document.getElementById('connectWalletBtn');
            connectButton.classList.add('loading');
            if (!window.ethereum) {
                showModal('No wallet detected. Please install <a href="https://metamask.io" target="_blank">MetaMask</a>.');
                connectButton.classList.remove('loading');
                return;
            }
            try {
                web3 = new Web3(window.ethereum);
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== '0x6d') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x6d' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [shibariumMainnet],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                siycContract = new web3.eth.Contract(SIYC_CONTRACT_ABI, SIYC_CONTRACT_ADDRESS);
                multiCallContract = new web3.eth.Contract(MULTICALL_CONTRACT_ABI, MULTICALL_CONTRACT_ADDRESS);
                showModal('Connected to Shibarium successfully!');
                updateWalletAddress();
                document.getElementById('batchTransferBtn').disabled = false;
                fetchOwnedNFTs();
            } catch (error) {
                showModal('Connection failed: ' + error.message);
            } finally {
                connectButton.classList.remove('loading');
            }
        }

        // Update wallet address display
        async function updateWalletAddress() {
            if (!accounts || accounts.length === 0) {
                document.getElementById('walletAddress').innerText = 'Not connected';
            } else {
                const shortAddress = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                document.getElementById('walletAddress').innerText = shortAddress;
            }
        }

        // Fetch and display owned NFTs
        async function fetchOwnedNFTs() {
            if (!web3 || !siycContract || !accounts) {
                showModal('Please connect your wallet first!');
                return;
            }
            const nftList = document.getElementById('nftList');
            nftList.innerHTML = '<p>Loading your NFTs...</p>';
            try {
                const tokenIds = await siycContract.methods.walletOfOwner(accounts[0]).call();
                if (tokenIds.length === 0) {
                    nftList.innerHTML = '<p>You don’t own any Shiba Inu Yacht Club NFTs yet.</p>';
                    return;
                }
                nftList.innerHTML = '';
                for (const tokenId of tokenIds) {
                    const tokenURI = await siycContract.methods.tokenURI(tokenId).call();
                    await displayNFT(tokenId, tokenURI);
                }
            } catch (error) {
                showModal('Failed to fetch NFTs: ' + error.message);
                nftList.innerHTML = '<p>Error loading NFTs.</p>';
            }
        }

        // Display individual NFT card
        async function displayNFT(tokenId, tokenURI) {
            const nftList = document.getElementById('nftList');
            let metadata;
            if (tokenURI.startsWith('data:application/json;base64,')) {
                const base64Data = tokenURI.split(',')[1];
                metadata = JSON.parse(atob(base64Data));
            } else {
                metadata = { name: `Token #${tokenId}`, image: 'Unknown' };
            }
            const nftDiv = document.createElement('div');
            nftDiv.className = 'nft-card';
            nftDiv.innerHTML = `
                <img src="${metadata.image}" alt="${metadata.name}">
                <p>${metadata.name} (ID: ${tokenId})</p>
                <input type="text" id="transferAddress${tokenId}" placeholder="Recipient Address">
                <button class="action-btn" onclick="transferNFT(${tokenId})">Transfer</button>
            `;
            nftList.appendChild(nftDiv);
        }

        // Transfer single NFT
        async function transferNFT(tokenId) {
            if (!web3 || !siycContract || !accounts) {
                showModal('Please connect your wallet first!');
                return;
            }
            const transferAddress = document.getElementById(`transferAddress${tokenId}`).value;
            if (!web3.utils.isAddress(transferAddress)) {
                showModal('Invalid Ethereum address!');
                return;
            }
            try {
                showModal('Transferring NFT...');
                await siycContract.methods.safeTransferFrom(accounts[0], transferAddress, tokenId).send({ from: accounts[0] });
                showModal('NFT transferred successfully!');
                fetchOwnedNFTs();
            } catch (error) {
                showModal('Transfer failed: ' + error.message);
            }
        }

        // Shuffle array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Batch transfer NFTs using SIYCMultiCall
        async function batchTransferNFTs() {
            if (!web3 || !siycContract || !multiCallContract || !accounts) {
                showModal('Please connect your wallet first!');
                return;
            }
            const batchInput = document.getElementById('batchInput').value.trim();
            const batchButton = document.getElementById('batchTransferBtn');
            batchButton.classList.add('loading');
            batchButton.disabled = true;

            try {
                // Parse input
                const lines = batchInput.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showModal('Please provide at least one address and amount.');
                    batchButton.classList.remove('loading');
                    batchButton.disabled = false;
                    return;
                }

                // Collect transfers
                const transfers = [];
                let totalAmount = 0;
                for (const line of lines) {
                    const [address, amountStr] = line.split(',').map(item => item.trim());
                    if (!web3.utils.isAddress(address)) {
                        showModal(`Invalid address: ${address}`);
                        batchButton.classList.remove('loading');
                        batchButton.disabled = false;
                        return;
                    }
                    const amount = parseInt(amountStr);
                    if (isNaN(amount) || amount < 1) {
                        showModal(`Invalid amount for address ${address}: ${amountStr}`);
                        batchButton.classList.remove('loading');
                        batchButton.disabled = false;
                        return;
                    }
                    transfers.push({ address, amount });
                    totalAmount += amount;
                }

                // Validate total amount
                if (totalAmount > 100) {
                    showModal('Total transfer amount exceeds 100 NFTs.');
                    batchButton.classList.remove('loading');
                    batchButton.disabled = false;
                    return;
                }

                // Fetch owned NFTs
                const tokenIds = await siycContract.methods.walletOfOwner(accounts[0]).call();
                if (tokenIds.length < totalAmount) {
                    showModal(`You only own ${tokenIds.length} NFTs, but requested to transfer ${totalAmount}.`);
                    batchButton.classList.remove('loading');
                    batchButton.disabled = false;
                    return;
                }

                // Randomly select NFTs
                const shuffledTokenIds = shuffleArray([...tokenIds]);
                const toAddresses = [];
                const selectedTokenIds = [];
                let tokenIndex = 0;

                // Build arrays for batch transfer
                for (const { address, amount } of transfers) {
                    for (let i = 0; i < amount; i++) {
                        toAddresses.push(address);
                        selectedTokenIds.push(shuffledTokenIds[tokenIndex++]);
                    }
                }

                // Confirm transfer details
                showModal(`Preparing to transfer ${totalAmount} NFTs in a single transaction...`);

                // Execute batch transfer via SIYCMultiCall
                await multiCallContract.methods.batchTransfer(
                    SIYC_CONTRACT_ADDRESS,
                    toAddresses,
                    selectedTokenIds
                ).send({ from: accounts[0] });

                showModal('Batch transfer completed successfully!');
                fetchOwnedNFTs();
            } catch (error) {
                showModal('Batch transfer failed: ' + error.message);
            } finally {
                batchButton.classList.remove('loading');
                batchButton.disabled = false;
            }
        }

        // Initialize page
        window.onload = () => {
            if (!window.ethereum) {
                showModal('No wallet detected. Please install <a href="https://metamask.io" target="_blank">MetaMask</a>.');
            }
        };

        // Handle chain change
        window.ethereum?.on('chainChanged', () => {
            window.location.reload();
        });

        // Handle account change
        window.ethereum?.on('accountsChanged', (newAccounts) => {
            accounts = newAccounts;
            updateWalletAddress();
            if (newAccounts.length === 0) {
                document.getElementById('batchTransferBtn').disabled = true;
            } else {
                connectWallet();
            }
        });

        // Bind connect wallet button
        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
    </script>
</body>
</html>
